<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>$JFREE ‚Äî simple arcade</title>
<link href="/favicon.ico" rel="icon" sizes="any"/>
<style>
:root { --bg:#0b1020; --panel:#111835; --accent:#2af07a; --yellow:#ffd54a; --danger:#ff5566; --text:#e8ecff; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;background-image: radial-gradient(1200px 600px at 50% 0%, rgba(17,24,53,.86) 0%, rgba(11,16,32,.86) 60%, rgba(6,9,19,.92) 100%), url('assets/bg.jpg'); background-size:cover;background-position:center;background-attachment:fixed;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
.wrap{display:flex;min-height:100%;align-items:center;justify-content:center;padding:18px}
.card{width:min(780px,96vw);background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.5);overflow:hidden}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;background:rgba(0,0,0,.3);border-bottom:1px solid rgba(255,255,255,.06)}
header h1{margin:0;font-size:26px;letter-spacing:.3px}
.btn{appearance:none;border:none;background:var(--accent);color:#07140f;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
#hud{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;padding:10px 14px;background:rgba(0,0,0,.15);border-bottom:1px solid rgba(255,255,255,.06);font-size:14px}
.badge{padding:6px 10px;border:1px dashed rgba(255,255,255,.25);border-radius:999px}
#game-holder{position:relative;background:radial-gradient(800px 400px at 50% -20%, #1b2658 0%, #111835 40%, #0b1020 100%)}
canvas{display:block;width:100%;height:64vh;min-height:390px;outline:none}
.hint-bar{font-size:13px;opacity:.85;padding:10px 14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.mobile-ctrl{position:absolute;inset:auto 0 10px 0;display:none;justify-content:center;gap:14px;pointer-events:none}
.mobile-ctrl .ctrl-btn{pointer-events:auto;padding:14px 18px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(5,10,20,.45);backdrop-filter:blur(6px);color:var(--text);font-weight:700}
footer.note{position:absolute;left:10px;bottom:8px;font-size:12px;opacity:.65} footer.note b{color:var(--accent)}
@media (max-width:820px){.mobile-ctrl{display:flex} canvas{height:70vh;min-height:360px} .mobile-ctrl .ctrl-btn{padding:18px 24px;font-size:16px}}


/* Back to Home floating button */
.return-home{
  position: fixed;
  top: 14px;
  left: 14px;
  z-index: 9999;
  font-weight: 800;
  text-decoration: none;
  padding: 10px 14px;
  border-radius: 999px;
  background: rgba(0,0,0,.45);
  color: #2af07a;
  border: 1px solid rgba(42,240,122,.6);
  box-shadow: 0 0 0 0 rgba(42,240,122,.45);
  animation: backPulse 2.6s ease-in-out infinite;
  backdrop-filter: blur(8px);
}
@keyframes backPulse {
  0%   { box-shadow: 0 0 0 0 rgba(42,240,122,.40); }
  50%  { box-shadow: 0 0 18px 5px rgba(42,240,122,.65); }
  100% { box-shadow: 0 0 0 0 rgba(42,240,122,.38); }
}
@media (max-width:600px){
  .return-home{ top:10px; left:10px; padding: 9px 12px; }
}
</style>
</head>
<body><a aria-label="Back to Home" class="return-home" href="../../website/index.html">‚Üê Back to $JFREE Site</a>
<div class="wrap">
<div aria-label="$JFREE game" class="card" role="application">
<header>
<h1><img alt="$JFREE" src="assets/coin.png" style="width:30px;height:30px;vertical-align:-6px;margin-right:10px;border-radius:50%;"/>$JFREE</h1>
<div style="display:flex;gap:8px;align-items:center">
<input id="volSlider" max="100" min="0" style="appearance:none;width:140px;height:8px;border-radius:6px;background:linear-gradient(90deg,#7aa8ff,#ffd54a);outline:none;cursor:pointer" type="range" value="35"/>
<button class="btn" id="btnMute" style="background:#88a4ff">üîä</button>
<button class="btn" disabled="" id="btnStart">Start</button>
</div>
</header>


<div id="walletLogin" style="display:flex;justify-content:center;gap:8px;padding:10px;align-items:center">
  <button class="btn" id="btnWallet">üîê Connect Wallet (Solana)</button>
  <small id="walletHint" style="opacity:.7">Phantom/Backpack compatible. Used only to sign a nonce ‚Äî no transactions.</small>
</div>


<div id="hud">
<div style="grid-column:1/-1;margin-top:6px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
<div class="badge">üë§ Username: <strong id="uname">‚Äî</strong></div>
<div class="badge">üèÜ 30‚ÄëDay Leaderboard (Top 10)</div><button class="btn" id="btnViewLB" style="padding:6px 10px;border-radius:8px">View</button>
<div id="lb" style="display:flex;gap:8px;flex-wrap:wrap"></div>
</div>
<div>Score: <strong id="score">0</strong></div>
<div>Best: <strong id="best">0</strong></div>
<div style="text-align:right">Lives: <strong id="lives">3</strong> ‚Ä¢ <span id="freezeHint"></span></div>
</div>
<div id="game-holder">
<img alt="coin" id="coinImg" src="assets/coin.png" style="display:none"/>
<img alt="bomb" id="bombImg" src="assets/bomb.png" style="display:none"/>
<img alt="super" id="superImg" src="assets/super.png" style="display:none"/>
<audio id="bgm" loop="" preload="auto" src="assets/theme.mp3" style="display:none"></audio>
<canvas id="game" tabindex="0"></canvas>
<div class="mobile-ctrl">
<div aria-label="Left" class="ctrl-btn" id="leftBtn">‚óÄÔ∏é Left</div>
<div aria-label="Right" class="ctrl-btn" id="rightBtn">Right ‚ñ∂Ô∏é</div>
</div>
<footer class="note">Powered by <b>Alexmkhn</b></footer>
</div>
<div class="hint-bar">
<div class="badge">Controls: ‚Üê ‚Üí or A/D ‚Ä¢ On mobile ‚Äî on-screen buttons</div>
<div class="badge">P ‚Äî pause ‚Ä¢ R ‚Äî restart</div>
</div>
</div>
</div>
<!-- Leaderboard Modal -->
<div id="lbModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:60">
<div style="background:#0b1020;border:1px solid rgba(255,255,255,.12);padding:16px;border-radius:14px;width:min(720px,94vw);max-height:86vh;overflow:auto;box-shadow:0 12px 40px rgba(0,0,0,.6)">
<div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px">
<h3 style="margin:0;font-size:18px">üèÜ 30‚ÄëDay Leaderboard</h3>
<button class="btn" id="lbClose" style="padding:8px 12px;border-radius:10px">Close</button>
</div>
<table id="lbTable" style="width:100%;border-collapse:collapse">
<thead><tr>
<th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.1)">#</th>
<th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.1)">Username</th>
<th style="text-align:right;padding:8px;border-bottom:1px solid rgba(255,255,255,.1)">Score</th>
</tr></thead>
<tbody></tbody>
</table>
</div>
</div>
<!-- Username Modal -->
<div id="usernameModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:60">
<div style="background:#0b1020;border:1px solid rgba(255,255,255,.12);padding:16px;border-radius:14px;width:min(440px,92vw);box-shadow:0 12px 40px rgba(0,0,0,.6)">
<h2 style="margin:0 0 10px;font-size:18px">Enter a unique Username</h2>
<p style="margin:0 0 10px;opacity:.85;font-size:13px">Allowed: letters, digits, _ and - (3‚Äì18 chars).</p>
<div style="display:flex;gap:8px">
<input id="unameInput" placeholder="your name" style="flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0f1630;color:#e8ecff;outline:none" type="text"/>
<button class="btn" id="unameSave">Save</button>
</div>
<p id="unameErr" style="color:#ff8e8e;height:16px;margin:8px 0 0;font-size:12px"></p>
</div>
</div>
<script>
(()=>{
// ===== REST Leaderboard =====
const USER_KEY = 'coin-dash-user-v1';
async function apiRegisterUsername(name){
  const res = await fetch('/api/register', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+(localStorage.getItem(SESSION_KEY)||'')}, body: JSON.stringify({ username:name }) });
  if (!res.ok) throw new Error('taken');
}
async function apiSubmit(username, score){
  await fetch('/api/submit', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+(localStorage.getItem(SESSION_KEY)||'')}, body: JSON.stringify({ username, score }) });
}
async function apiTop10(){ const r = await fetch('/api/leaderboard'); if(!r.ok) throw 0; return await r.json(); }
async function apiAll(){ const r = await fetch('/api/leaderboard_all'); if(!r.ok) throw 0; return await r.json(); }

// ===== Music (no autoplay) =====
const bgm = document.getElementById('bgm');
const VOL_KEY='jfree-vol', MUTE_KEY='jfree-muted';
let musicOn = (localStorage.getItem(MUTE_KEY)!=='1');
const volSaved = parseFloat(localStorage.getItem(VOL_KEY));
bgm.volume = Number.isFinite(volSaved) ? Math.max(0,Math.min(1,volSaved)) : 0.35;
document.getElementById('btnMute').textContent = musicOn ? 'üîä':'üîá';
document.getElementById('btnMute').addEventListener('click', ()=>{ musicOn=!musicOn; localStorage.setItem(MUTE_KEY, musicOn?'0':'1'); document.getElementById('btnMute').textContent = musicOn?'üîä':'üîá'; if(!musicOn) bgm.pause(); });
document.getElementById('volSlider').addEventListener('input', e=>{ const v=Math.max(0,Math.min(100,parseInt(e.target.value||'0',10)))/100; bgm.volume=v; localStorage.setItem(VOL_KEY,String(v)); });
function tryPlayMusic(){ if(musicOn){ bgm.play().catch(()=>{}); } }

// ===== Canvas/Game =====
const canvas=document.getElementById('game'), ctx=canvas.getContext('2d'), dpr=Math.max(1,window.devicePixelRatio||1);
const coinImg=document.getElementById('coinImg'), bombImg=document.getElementById('bombImg'), superImg=document.getElementById('superImg');
let W=0,H=0;
const state={ running:false, paused:false, over:false, t:0, score:0, lives:3, spawnInt:900, speed:210, coinSpawnInt:1200, coinSpawnMin:700, freezeBombsUntil:0, shake:0, leftHeld:false, rightHeld:false };
const player={ x:0,y:0,w:46,h:20,vx:0,maxSpeed:420,acc:1800,friction:2200 };
const items=[];

// Input
const keys={left:false,right:false};
window.addEventListener('keydown', e=>{ const k=e.key.toLowerCase(); if(k==='arrowleft'||k==='a') keys.left=true; if(k==='arrowright'||k==='d') keys.right=true; if(k==='p') togglePause(); if(k==='r'){ reset(); start(); } });
window.addEventListener('keyup', e=>{ const k=e.key.toLowerCase(); if(k==='arrowleft'||k==='a') keys.left=false; if(k==='arrowright'||k==='d') keys.right=false; });

function bindHold(id,on,off){ const el=document.getElementById(id); el.addEventListener('touchstart',e=>{e.preventDefault();on();}); el.addEventListener('touchend',e=>{e.preventDefault();off();}); el.addEventListener('touchcancel',e=>{e.preventDefault();off();}); el.addEventListener('mousedown',()=>on()); el.addEventListener('mouseup',()=>off()); el.addEventListener('mouseleave',()=>off()); }
bindHold('leftBtn', ()=>state.leftHeld=true, ()=>state.leftHeld=false);
bindHold('rightBtn',()=>state.rightHeld=true,()=>state.rightHeld=false);
canvas.addEventListener('touchstart', e=>{ const t=e.touches[0]; if(!t) return; const r=canvas.getBoundingClientRect(); const x=t.clientX-r.left; state.leftHeld = x<r.width/2; state.rightHeld = !state.leftHeld; e.preventDefault(); });
canvas.addEventListener('touchend', ()=>{ state.leftHeld=false; state.rightHeld=false; });

function resize(){ const rect=canvas.getBoundingClientRect(); W=Math.floor(rect.width*dpr); H=Math.floor(rect.height*dpr); canvas.width=W; canvas.height=H; ctx.setTransform(dpr,0,0,dpr,0,0); }
window.addEventListener('resize', resize);
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); } function rand(a,b){ return Math.random()*(b-a)+a; }

function reset(){ resize(); state.running=false; state.paused=false; state.over=false; state.t=0; state.score=0; state.lives=3; state.spawnInt=900; state.coinSpawnInt=1200; state.speed=210; state.freezeBombsUntil=0; state.shake=0; items.length=0; player.w=Math.max(40,Math.min(60,W*0.08)); player.h=player.w*0.4; player.x=W/2-player.w/2; player.y=H-player.h-18; player.vx=0; updateHud(); draw(0); }

// Spawns
function spawnCoinOnly(){ const r=rand(10,18); const vy=0.7*(rand(120,220)+state.speed*0.20); items.push({x:rand(14,(W/dpr)-14),y:-r-10,r,vy,type:'coin'}); }
function spawn(){ const roll=Math.random(); let type='coin'; if(roll>0.95975) type='super'; else if(roll>0.88) type='gem'; else if(roll<0.184) type='bomb'; let r,vy; if(type==='bomb'){ r=rand(16,24); vy=0.7*(rand(160,260)+state.speed*0.28); } else if(type==='gem'){ r=rand(12,20); vy=rand(130,230)+state.speed*0.22; } else if(type==='super'){ r=rand(18,26); vy=0.7*(rand(120,200)+state.speed*0.18); } else { r=rand(10,18); vy=0.7*(rand(120,220)+state.speed*0.20); } items.push({x:rand(14,(W/dpr)-14),y:-r-10,r,vy,type}); }

// Loop
let last=0;
function start(){ state.running=true; state.paused=false; last=performance.now(); requestAnimationFrame(loop); document.getElementById('btnStart').textContent='Pause'; tryPlayMusic(); }
function togglePause(){ if(!state.running) return; state.paused=!state.paused; document.getElementById('btnStart').textContent = state.paused?'Resume':'Pause'; if(!state.paused){ last=performance.now(); requestAnimationFrame(loop); tryPlayMusic(); } else { bgm.pause(); draw(0); drawPause(); } }
document.getElementById('btnStart').addEventListener('click', ()=>{ if(!state.running) start(); else togglePause(); });

function loop(ts){ if(!state.running||state.paused) return; const dt=Math.min(0.032,(ts-last)/1000); last=ts; step(dt); draw(dt); if(!state.over) requestAnimationFrame(loop); }

function step(dt){
  state.t += dt*1000;

  // move
  const wantLeft = (state.leftHeld || keys.left), wantRight = (state.rightHeld || keys.right);
  if (wantLeft && !wantRight) player.vx -= player.acc*dt;
  else if (wantRight && !wantLeft) player.vx += player.acc*dt;
  else { if(player.vx>0) player.vx=Math.max(0,player.vx-player.friction*dt); if(player.vx<0) player.vx=Math.min(0,player.vx+player.friction*dt); }
  player.vx = clamp(player.vx, -player.maxSpeed, player.maxSpeed); player.x = clamp(player.x + player.vx*dt, 8, (W/dpr)-player.w-8);

  // spawns
  if (state.t % state.spawnInt < 16) spawn();
  if (state.t % state.coinSpawnInt < 16) spawnCoinOnly();
  state.speed += 1.8*dt;
  state.spawnInt = Math.max(340, state.spawnInt - 6*dt);
  state.coinSpawnInt = Math.max(state.coinSpawnMin, state.coinSpawnInt - 3*dt);

  // update items
  const now = performance.now();
  for (let i=items.length-1;i>=0;i--){
    const it=items[i];
    const frozen = (it.type==='bomb') && (now < state.freezeBombsUntil);
    if (!frozen) it.y += it.vy*dt;
    if (it.y - it.r > (H/dpr)+40){ items.splice(i,1); continue; }

    const px = clamp(it.x, player.x, player.x+player.w), py = clamp(it.y, player.y, player.y+player.h);
    const dx = it.x-px, dy = it.y-py;
    if (dx*dx + dy*dy <= it.r*it.r){
      if (it.type==='bomb') onBomb();
      else if (it.type==='super') onSuper();
      else onCoin(it.type==='gem');
      items.splice(i,1);
    }
  }
}

// HUD
function updateHud(){ document.getElementById('score').textContent = state.score; document.getElementById('lives').textContent = state.lives; const now=performance.now(); document.getElementById('freezeHint').textContent = (now < state.freezeBombsUntil) ? ('Freeze: '+Math.ceil((state.freezeBombsUntil-now)/1000)+'s') : ''; }

// SFX
const ACtx = window.AudioContext || window.webkitAudioContext; let audioCtx=null; function ensureAudio(){ if(!audioCtx) audioCtx=new ACtx(); }
function beep(f=880,d=0.08,t='sine',g=0.06){ ensureAudio(); const at=audioCtx.currentTime; const o=audioCtx.createOscillator(), gn=audioCtx.createGain(); o.type=t; o.frequency.value=f; gn.gain.setValueAtTime(g,at); gn.gain.exponentialRampToValueAtTime(0.0001, at+d); o.connect(gn).connect(audioCtx.destination); o.start(at); o.stop(at+d); }
function boom(){ ensureAudio(); const at=audioCtx.currentTime; const o=audioCtx.createOscillator(), gn=audioCtx.createGain(); o.type='sawtooth'; o.frequency.setValueAtTime(160,at); o.frequency.exponentialRampToValueAtTime(40, at+0.25); gn.gain.setValueAtTime(0.08,at); gn.gain.exponentialRampToValueAtTime(0.0001, at+0.28); o.connect(gn).connect(audioCtx.destination); o.start(at); o.stop(at+0.3); }

// Events
function onBomb(){ state.lives--; updateHud(); flash(220,true); boom(); state.shake=280; if (state.lives<=0) gameOver(); }
function onSuper(){ state.freezeBombsUntil = performance.now() + 6000; flash(240,false); beep(880,.09,'triangle',.07); setTimeout(()=>beep(1320,.08,'triangle',.06),60); }
function onCoin(isGem){ const add=isGem?50:10; state.score+=add; updateHud(); beep(920,.06,'sine',.05); }

// Visual FX
let flashTimer=0, flashColor='rgba(255,85,102,0.28)'; function flash(ms,isDanger){ flashTimer=ms; flashColor=isDanger?'rgba(255,85,102,0.28)':'rgba(42,240,122,0.22)'; }
let scorePulse=0, lastAdd=0; function pulseScore(add){ scorePulse=420; lastAdd=add; }

function draw(dt){
  if (state.shake>0){ state.shake-=dt*1000; const a=Math.min(1,state.shake/280); const mag=6*a; ctx.save(); ctx.translate((Math.random()-0.5)*mag,(Math.random()-0.5)*mag); }
  ctx.clearRect(0,0,W/dpr,H/dpr);
  const grd=ctx.createLinearGradient(0,0,0,H/dpr); grd.addColorStop(0,'#0f1a3a'); grd.addColorStop(1,'#0b1020'); ctx.fillStyle=grd; ctx.fillRect(0,0,W/dpr,H/dpr);
  drawPlayer(); for(const it of items) drawItem(it);
  if (state.shake>0) ctx.restore();
  if (flashTimer>0){ flashTimer-=dt*1000; ctx.fillStyle=flashColor; ctx.fillRect(0,0,W/dpr,H/dpr); }
}

function drawPlayer(){ const x=player.x,y=player.y,w=player.w,h=player.h; ctx.fillStyle='#1bd07a'; ctx.fillRect(x,y,w,h); ctx.fillStyle='#0a261b'; ctx.fillRect(x+4,y+4,w-8,4); }
function drawItem(e){
  const {x,y,r,type} = e;
  if (type==='bomb'){
    ctx.save(); ctx.shadowColor = (performance.now() < state.freezeBombsUntil) ? 'rgba(120,200,255,0.9)' : 'rgba(255,80,80,0.9)'; ctx.shadowBlur = 12;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.closePath(); ctx.save(); ctx.clip();
    if (bombImg && bombImg.complete){ ctx.drawImage(bombImg, x-r, y-r, r*2, r*2); } else { ctx.fillStyle='#333'; ctx.fillRect(x-r,y-r,r*2,r*2); }
    ctx.restore();
    // fuse + flicker
    ctx.lineWidth=2; ctx.strokeStyle='#ffd166'; ctx.beginPath(); ctx.moveTo(x+r*0.2, y-r*0.6); ctx.lineTo(x+r*0.95, y-r*1.2); ctx.stroke();
    const flick=0.7+0.3*Math.sin(performance.now()/80); ctx.globalAlpha=flick; ctx.fillStyle=(performance.now()<state.freezeBombsUntil)?'rgba(150,210,255,0.95)':'rgba(255,210,90,0.95)'; ctx.beginPath(); ctx.arc(x+r*0.98,y-r*1.2,3.2,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; ctx.restore();
  } else if (type==='super'){
    ctx.save(); ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.closePath(); ctx.clip(); if (superImg&&superImg.complete){ ctx.drawImage(superImg,x-r,y-r,r*2,r*2);} else { ctx.fillStyle='#aee6ff'; ctx.fillRect(x-r,y-r,r*2,r*2);} ctx.restore();
    ctx.lineWidth=2; ctx.strokeStyle='#8fd3ff'; ctx.beginPath(); ctx.arc(x,y,r-1,0,Math.PI*2); ctx.stroke();
  } else {
    ctx.save(); ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.closePath(); ctx.clip(); if (coinImg&&coinImg.complete){ ctx.drawImage(coinImg,x-r,y-r,r*2,r*2);} else { const g=ctx.createRadialGradient(x-r*0.5,y-r*0.5,r*0.2,x,y,r); g.addColorStop(0,'#fffad1'); g.addColorStop(1,'#ffd54a'); ctx.fillStyle=g; ctx.fillRect(x-r,y-r,r*2,r*2);} ctx.restore();
    ctx.lineWidth=2; ctx.strokeStyle='rgba(0,0,0,0.35)'; ctx.beginPath(); ctx.arc(x,y,r-1,0,Math.PI*2); ctx.stroke();
  }
}

function drawPause(){ const cx=(W/dpr)/2, cy=(H/dpr)/2; ctx.save(); ctx.textAlign='center'; ctx.fillStyle='rgba(0,0,0,0.35)'; ctx.fillRect(0,0,W/dpr,H/dpr); ctx.fillStyle='#e8ecff'; ctx.font='800 28px system-ui'; ctx.fillText('PAUSED',cx,cy-8); ctx.font='600 14px system-ui'; ctx.fillText('Press P or click ‚ÄúResume‚Äù',cx,cy+18); ctx.restore(); }

function gameOver(){
  state.over=true; state.running=false; document.getElementById('btnStart').textContent='Start'; bgm.pause();
  const bestKey='coin-dash-best-v1'; const best=+localStorage.getItem(bestKey)||0; if(state.score>best){ localStorage.setItem(bestKey,String(state.score)); document.getElementById('best').textContent=state.score; }
  const u=localStorage.getItem(USER_KEY); if(u) apiSubmit(u, state.score).then(()=>{ try{ renderTop(); }catch(_){} }).catch(()=>{});
  // overlay
  draw(0); const cx=(W/dpr)/2,cy=(H/dpr)/2; ctx.save(); ctx.textAlign='center'; ctx.fillStyle='rgba(12,6,14,0.55)'; ctx.fillRect(0,0,W/dpr,H/dpr); ctx.fillStyle='#e8ecff'; ctx.font='800 30px system-ui'; ctx.fillText('GAME OVER',cx,cy-16); ctx.font='600 16px system-ui'; ctx.fillText('Score: '+state.score, cx, cy+12); ctx.restore();
}

// Leaderboard UI
async function renderTop(){ const lb=document.getElementById('lb'); if(!lb) return; lb.innerHTML='loading...'; try{ const list=await apiTop10(); lb.innerHTML=''; list.forEach((e,i)=>{ const s=document.createElement('span'); s.className='badge'; s.textContent=`${i+1}. ${e.username}: ${e.score}`; lb.appendChild(s); }); if(!list.length) lb.innerHTML='<span class="badge">No entries yet</span>'; } catch{ lb.innerHTML='<span class="badge">Leaderboard unavailable</span>'; } }
const lbModal=document.getElementById('lbModal'); document.getElementById('btnViewLB').addEventListener('click', ()=>{ lbModal.style.display='flex'; loadFullLB(); }); document.getElementById('lbClose').addEventListener('click', ()=>{ lbModal.style.display='none'; }); lbModal.addEventListener('click', e=>{ if(e.target===lbModal) lbModal.style.display='none'; });
async function loadFullLB(){ const tbody=document.querySelector('#lbTable tbody'); tbody.innerHTML='<tr><td colspan="3" style="padding:10px;opacity:.7">Loading‚Ä¶</td></tr>'; try{ const list=await apiAll(); tbody.innerHTML=''; list.forEach((e,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.04)">${i+1}</td><td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.04)">${e.username}</td><td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.04);text-align:right">${e.score}</td>`; tbody.appendChild(tr); }); if(!list.length) tbody.innerHTML='<tr><td colspan="3" style="padding:10px;opacity:.7">No entries yet.</td></tr>'; } catch{ tbody.innerHTML='<tr><td colspan="3" style="padding:10px;color:#ff8e8e">Failed to load leaderboard.</td></tr>'; } }

// Username modal
const unameModal=document.getElementById('usernameModal'); const unameInput=document.getElementById('unameInput'); const unameSave=document.getElementById('unameSave'); const unameErr=document.getElementById('unameErr');
function showU(){ unameModal.style.display='flex'; } function hideU(){ unameModal.style.display='none'; }
function validName(v){ return /^[a-zA-Z0-9_-]{3,18}$/.test(v); }
async function claim(){ const v=(unameInput.value||'').trim(); if(!validName(v)){ unameErr.textContent='Invalid format: a-z, 0-9, _ or -, 3‚Äì18 chars.'; return; } unameErr.textContent='Checking...'; try{ await apiRegisterUsername(v); localStorage.setItem('coin-dash-user-v1', v); document.getElementById('uname').textContent=v; unameErr.textContent=''; hideU(); renderTop(); } catch{ unameErr.textContent='Name is taken. Choose another.'; } }
unameSave.addEventListener('click', claim); unameInput.addEventListener('keydown', e=>{ if(e.key==='Enter') claim(); }); unameModal.addEventListener('click', e=>{ if(e.target===unameModal) hideU(); });
function ensureUsername(){ /* Telegram-only auth: skip manual username modal */ }


// Init
function updateBest(){ document.getElementById('best').textContent = (+localStorage.getItem('coin-dash-best-v1') || 0); }
function init(){ resize(); ensureUsername(); renderTop(); updateBest(); reset(); }
init();

  const btn = document.getElementById('btnGuestLogin');
  if (btn) btn.addEventListener('click', onWalletLogin);
})();
// ===== Telegram Auth =====
const SESSION_KEY = 'jfree_session_token';
const NAME_KEY = 'jfree_session_name';

function setAuthUI(name){
  try{ localStorage.setItem('coin-dash-user-v1', name||''); }catch(e){}

  document.getElementById('uname').textContent = name||'‚Äî';
  const startBtn = document.getElementById('btnStart');
  if (name) { startBtn.removeAttribute('disabled'); }
  else { startBtn.setAttribute('disabled','disabled'); }
}

async function onWalletLogin(user){
  try{
    const res = await fetch('/api/telegram_login', {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+(localStorage.getItem(SESSION_KEY)||'')},
      body: JSON.stringify(user)
    });
    if(!res.ok) throw new Error('auth failed');
    const data = await res.json();
    localStorage.setItem(SESSION_KEY, data.token);
    localStorage.setItem(NAME_KEY, data.username);
    setAuthUI(data.username);
    document.getElementById('walletLogin')?.remove();
  }catch(e){
    alert('Telegram authorization failed. Please try again.');
  }
}

// Initialize auth from localStorage
(function(){
  const tok = localStorage.getItem(SESSION_KEY);
  const name = localStorage.getItem(NAME_KEY);
  if (tok && name) {
    setAuthUI(name);
    const loginDiv = document.getElementById('walletLogin');
    if (loginDiv) loginDiv.style.display = 'none';
  } else {
    setAuthUI(null);
  }

  const btn = document.getElementById('btnGuestLogin');
  if (btn) btn.addEventListener('click', onWalletLogin);
})();
</script>
</body>
</html>
